<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analisis Mortalitas dan FMSY</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.1/dist/chartjs-plugin-annotation.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2c3e50;
      --primary-light: #3d566e;
      --secondary: #3498db;
      --secondary-dark: #2980b9;
      --accent: #e74c3c;
      --success: #2ecc71;
      --warning: #f39c12;
      --danger: #e74c3c;
      --light: #f5f7fa;
      --dark: #333;
      --gray: #95a5a6;
      --card-shadow: 0 4px 12px rgba(0,0,0,0.08);
      --border-radius: 12px;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 1rem;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
      color: var(--dark);
      max-width: 1400px;
      margin: 0 auto;
      min-height: 100vh;
      line-height: 1.6;
    }
    
    /* ======= HEADER SECTION ======= */
    .app-header {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .title-card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 2rem 1.5rem;
      text-align: center;
      border-top: 4px solid var(--secondary);
    }
    
    h1 {
      color: var(--primary);
      margin: 0 0 1rem 0;
      font-size: 2.2rem;
      position: relative;
      padding-bottom: 0.8rem;
    }
    
    h1:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: var(--secondary);
      border-radius: 2px;
    }
    
    .title-card p {
      max-width: 800px;
      margin: 0 auto;
      color: var(--primary-light);
      font-size: 1.1rem;
    }
    
    /* ======= CREATOR SECTION ======= */
    .creator-info-card {
      background: linear-gradient(to right, #f0f7ff, #e6f2ff);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 1.5rem;
      margin-bottom: 1.8rem;
      display: flex;
      align-items: center;
      gap: 20px;
      border-left: 4px solid var(--secondary);
    }
    
    .creator-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 2.5rem;
      flex-shrink: 0;
    }
    
    .creator-details {
      flex: 1;
    }
    
    .creator-details h3 {
      margin: 0 0 8px 0;
      color: var(--primary);
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .creator-details h3 i {
      color: var(--secondary);
    }
    
    .creator-details p {
      margin: 4px 0;
      color: var(--primary-light);
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .creator-details p i {
      width: 20px;
      color: var(--secondary);
      text-align: center;
    }
    
    /* ======= CARD STYLES ======= */
    .card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 1.8rem;
      margin-bottom: 1.8rem;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    
    h2 {
      color: var(--secondary-dark);
      margin-top: 0;
      margin-bottom: 1.5rem;
      font-size: 1.7rem;
      padding-bottom: 0.6rem;
      border-bottom: 2px solid #eaeff5;
    }
    
    /* ======= INPUT SECTION ======= */
    .input-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.2rem;
      margin-bottom: 1.8rem;
    }
    
    .input-row {
      display: flex;
      flex-direction: column;
    }
    
    label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    label:after {
      content: ':';
    }
    
    input, select {
      padding: 0.9rem;
      border: 1px solid #dde4ec;
      border-radius: 8px;
      font-size: 1rem;
      background: #fafcff;
      transition: all 0.3s;
    }
    
    input:focus, select:focus {
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
      outline: none;
      background: white;
    }
    
    .file-input {
      margin: 1.2rem 0;
      padding: 1.2rem;
      background: #f8fbff;
      border-radius: 8px;
      border: 1px dashed #c2dcf7;
    }
    
    .file-input label {
      display: block;
      margin-bottom: 0.8rem;
    }
    
    .file-input input[type="file"] {
      padding: 0.8rem;
      background: white;
      border: 1px solid #dde4ec;
      border-radius: 8px;
      width: 100%;
    }
    
    .button-container {
      display: flex;
      justify-content: center;
      margin-top: 1.2rem;
    }
    
    button {
      background: var(--secondary);
      color: white;
      border: none;
      padding: 1rem 2.2rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 6px rgba(52, 152, 219, 0.3);
    }
    
    button:hover {
      background: var(--secondary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 10px rgba(52, 152, 219, 0.4);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    /* ======= EXPLANATION SECTION ======= */
    .explanation {
      background: #f8fbfe;
      border-left: 4px solid var(--secondary);
      padding: 1.5rem;
      margin-top: 1.8rem;
      border-radius: 0 8px 8px 0;
    }
    
    .explanation h4 {
      margin-top: 0;
      color: var(--primary);
      font-size: 1.2rem;
    }
    
    .explanation ul {
      padding-left: 1.2rem;
    }
    
    .explanation li {
      margin-bottom: 0.6rem;
    }
    
    /* ======= RESULTS SECTION ======= */
    .results {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 1.8rem;
      margin-top: 1.2rem;
    }
    
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
    
    .result-card {
      background: linear-gradient(to bottom right, #f0f8ff, #e6f2ff);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
      border-top: 3px solid var(--secondary);
      transition: transform 0.3s;
    }
    
    .result-card:hover {
      transform: translateY(-3px);
    }
    
    .result-card h4 {
      margin-top: 0;
      margin-bottom: 0.8rem;
      color: var(--primary);
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .result-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--secondary-dark);
      margin: 0.5rem 0;
    }
    
    .result-card p {
      color: var(--primary-light);
      margin: 0;
      font-size: 0.95rem;
    }
    
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-good {
      background: var(--success);
      box-shadow: 0 0 8px rgba(46, 204, 113, 0.5);
    }
    
    .status-warning {
      background: var(--warning);
      box-shadow: 0 0 8px rgba(243, 156, 18, 0.5);
    }
    
    .status-danger {
      background: var(--danger);
      box-shadow: 0 0 8px rgba(231, 76, 60, 0.5);
    }
    
    /* ======= CHARTS SECTION ======= */
    .chart-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
      gap: 1.8rem;
    }
    
    .chart-container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 1.5rem;
      margin-bottom: 1.8rem;
      overflow: hidden;
      position: relative;
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.2rem;
    }
    
    .chart-header h3 {
      margin: 0;
      color: var(--primary);
      font-size: 1.4rem;
    }
    
    .download-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .download-btn:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    canvas {
      width: 100% !important;
    }
    
    /* ======= DATA TABLE ======= */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.95rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    
    .data-table th {
      background-color: #f0f7ff;
      color: var(--primary);
      font-weight: 600;
      padding: 12px 15px;
      text-align: left;
    }
    
    .data-table td {
      padding: 10px 15px;
      border-bottom: 1px solid #eaeff5;
    }
    
    .data-table tr:nth-child(even) {
      background-color: #fafcff;
    }
    
    .data-table tr:hover {
      background-color: #f0f7ff;
    }
    
    /* ======= FOOTER ======= */
    .footer {
      text-align: center;
      margin-top: 3rem;
      padding: 1.5rem;
      color: var(--primary-light);
      font-size: 0.95rem;
      border-top: 1px solid #eaeff5;
    }
    
    /* ======= UTILITY CLASSES ======= */
    .error {
      color: var(--danger);
      background: rgba(231, 76, 60, 0.08);
      padding: 8px 12px;
      border-radius: 6px;
      margin: 5px 0;
    }
    
    /* ======= RESPONSIVE ADJUSTMENTS ======= */
    @media (max-width: 1200px) {
      .chart-row {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      body {
        padding: 0.8rem;
      }
      
      .app-header {
        gap: 1rem;
      }
      
      .creator-info-card {
        flex-direction: column;
        text-align: center;
        padding: 1.2rem;
      }
      
      .creator-avatar {
        margin-bottom: 1rem;
      }
      
      .creator-details p {
        justify-content: center;
      }
      
      h1 {
        font-size: 1.8rem;
        padding-bottom: 0.6rem;
      }
      
      .title-card {
        padding: 1.5rem 1rem;
      }
      
      .card {
        padding: 1.4rem;
      }
      
      h2 {
        font-size: 1.5rem;
      }
      
      .input-group {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .results-grid {
        grid-template-columns: 1fr;
      }
      
      .chart-container {
        padding: 1.2rem;
      }
      
      .chart-row {
        gap: 1.2rem;
      }
    }
    
    @media (max-width: 480px) {
      h1 {
        font-size: 1.6rem;
      }
      
      h2 {
        font-size: 1.3rem;
      }
      
      .result-value {
        font-size: 1.6rem;
      }
      
      button {
        width: 100%;
        padding: 1rem;
      }
      
      .chart-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .download-btn {
        align-self: flex-end;
      }
    }
  </style>
</head>
<body>
  <!-- Header Section -->
  <div class="app-header">
    <div class="title-card">
      <h1>Estimasi Mortalitas dan F<sub>MSY</sub> Berdasarkan Data Panjang</h1>
      <p>Analisis ini menggunakan metode Length-Converted Catch Curve untuk estimasi mortalitas total (Z) dan pendekatan empiris untuk estimasi mortalitas alami (M).</p>
    </div>
  </div>

  <!-- Creator Info Section -->
  <div class="creator-info-card">
  <p>Dikembangkan oleh :<br></p>
    <div class="creator-details">
      <h3><i class="fas fa-user"></i> Andy Rasyadi, S.Pi., M.Si.</h3>
      <p><i class="fas fa-university"></i> Dosen Manajemen Sumberdaya Perairan, Fakultas Kelautan dan Perikanan, Universitas Udayana</p>
    </div>
  </div>

  <div class="card">
    <h2>Parameter Input</h2>
    <div class="input-group">
      <div class="input-row">
        <label for="k">K (Konstanta Pertumbuhan)</label>
        <input type="number" id="k" value="0.34" step="0.01" />
      </div>
      <div class="input-row">
        <label for="temp">T (Suhu Rata-rata Laut, °C)</label>
        <input type="number" id="temp" value="28" step="0.1" />
      </div>
      <div class="input-row">
        <label for="linf">L∞ (Panjang Asimtotik, cm)</label>
        <input type="number" id="linf" value="30.66" step="0.01" />
      </div>
      <div class="input-row">
        <label for="tc">t<sub>c</sub> (Usia Penangkapan, tahun)</label>
        <input type="number" id="tc" value="0.5" step="0.1" />
      </div>
      <div class="input-row">
        <label for="tr">t<sub>r</sub> (Usia Rekrutmen, tahun)</label>
        <input type="number" id="tr" value="0.3" step="0.1" />
      </div>
      <div class="input-row">
        <label for="methodM">Metode Estimasi Mortalitas Alami (M)</label>
        <select id="methodM">
          <option value="pauly">Pauly (1980)</option>
          <option value="beverton">Beverton-Holt (M=1.5K)</option>
        </select>
      </div>
    </div>

    <div class="file-input">
      <label for="freqCsvInput">Unggah Data Frekuensi Panjang (CSV)</label>
      <input type="file" id="freqCsvInput" accept=".csv" />
      <small>Format: panjang (cm), frekuensi (contoh: 15,42)</small>
    </div>

    <div class="button-container">
      <button onclick="calculateMortality()">
        <i class="fas fa-calculator"></i>
        Hitung Estimasi Mortalitas
      </button>
    </div>
    
    <div class="explanation">
      <h4>Metodologi:</h4>
      <ul>
        <li><strong>Z (Mortalitas Total)</strong>: Diestimasi menggunakan metode Length-Converted Catch Curve</li>
        <li><strong>M (Mortalitas Alami)</strong>: Diestimasi menggunakan rumus Pauly (1980) atau pendekatan Beverton-Holt (M=1.5K)</li>
        <li><strong>F (Mortalitas Penangkapan)</strong>: Dihitung sebagai F = Z - M</li>
        <li><strong>F<sub>MSY</sub></strong>: Ditentukan melalui simulasi model hasil per-rekrut</li>
        <li><strong>F<sub>0.1</sub></strong>: Tingkat F di mana kemiringan kurva Y/R adalah 10% dari kemiringan di F=0</li>
      </ul>
    </div>
  </div>

  <div class="results">
    <h2>Hasil Estimasi</h2>
    <div id="output"></div>
    <div id="debugOutput"></div>
  </div>

  <div class="chart-row">
    <div class="chart-container">
      <div class="chart-header">
        <h3>Length-Converted Catch Curve</h3>
        <button class="download-btn" onclick="downloadChart('catchCurveChart')">
          <i class="fas fa-download"></i> Unduh
        </button>
      </div>
      <canvas id="catchCurveChart"></canvas>
    </div>
    <div class="chart-container">
      <div class="chart-header">
        <h3>Hasil Per-Rekrut (Y/R)</h3>
        <button class="download-btn" onclick="downloadChart('yprChart')">
          <i class="fas fa-download"></i> Unduh
        </button>
      </div>
      <canvas id="yprChart"></canvas>
    </div>
  </div>

  <div class="footer">
    <p>© 2025 Andy Rasyadi | Aplikasi Analisis Perikanan Berkelanjutan | Fakultas Kelautan dan Perikanan - Universitas Udayana</p>
  </div>

  <script>
    // Data dan variabel global
    let freqData = [];
    let catchCurveChart = null;
    let yprChart = null;

    // Handler untuk upload file CSV
    document.getElementById("freqCsvInput").addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (event) {
        const lines = event.target.result.split(/\r?\n/);
        freqData = [];
        
        lines.forEach((line, index) => {
          line = line.trim();
          if (line === '') return; // Skip baris kosong
          const parts = line.split(',');
          if (parts.length < 2) return; // Skip baris yang tidak memiliki cukup kolom
          
          const length = parseFloat(parts[0]);
          const freq = parseFloat(parts[1]);
          
          if (!isNaN(length) && !isNaN(freq)) {
            freqData.push({ length, freq });
          }
        });
        
        if (freqData.length > 0) {
          alert(`Data distribusi panjang berhasil dimuat: ${freqData.length} kelas`);
        } else {
          alert("Format file tidak valid. Pastikan file CSV berisi kolom panjang dan frekuensi.");
        }
      };
      reader.readAsText(file);
    });

    // Fungsi untuk mengunduh grafik
    function downloadChart(chartId) {
      let canvas, filename;
      
      if (chartId === 'catchCurveChart' && catchCurveChart) {
        canvas = document.getElementById('catchCurveChart');
        filename = 'length-converted-catch-curve.png';
      } else if (chartId === 'yprChart' && yprChart) {
        canvas = document.getElementById('yprChart');
        filename = 'hasil-per-rekrut.png';
      } else {
        alert('Grafik belum tersedia. Silakan hitung estimasi terlebih dahulu.');
        return;
      }
      
      const link = document.createElement('a');
      link.download = filename;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    // Fungsi utama untuk menghitung mortalitas
    function calculateMortality() {
      // Ambil nilai input
      const k = parseFloat(document.getElementById("k").value);
      const temp = parseFloat(document.getElementById("temp").value);
      const linf = parseFloat(document.getElementById("linf").value);
      const tc = parseFloat(document.getElementById("tc").value);
      const tr = parseFloat(document.getElementById("tr").value);
      const methodM = document.getElementById("methodM").value;
      
      // Validasi input
      if (isNaN(k) || isNaN(temp) || isNaN(linf) || isNaN(tc) || isNaN(tr)) {
        alert("Harap isi semua parameter dengan nilai numerik yang valid");
        return;
      }
      
      // Estimasi M (Mortalitas Alami)
      let M;
      if (methodM === "pauly") {
        // Rumus empiris Pauly (1980)
        M = Math.pow(10, -0.0066 - 0.279 * Math.log10(linf) + 
                     0.6543 * Math.log10(k) + 0.4634 * Math.log10(temp));
      } else {
        // Pendekatan Beverton-Holt
        M = 1.5 * k;
      }
      
      // Estimasi Z (Mortalitas Total) menggunakan Length-Converted Catch Curve
      let Z, regressionPoints, catchCurvePoints, debugInfo;
      if (freqData.length > 0) {
        const lcccResult = calculateZWithLCCC(freqData, k, linf);
        Z = lcccResult.Z;
        regressionPoints = lcccResult.regressionPoints;
        catchCurvePoints = lcccResult.catchCurvePoints;
        debugInfo = lcccResult.debugInfo;
        
        // Tampilkan debug info
        document.getElementById("debugOutput").innerHTML = debugInfo;
        
        if (isNaN(Z) || Z <= 0) {
          alert("Tidak dapat menghitung Z dari data frekuensi. Pastikan data mencakup bagian menurun yang cukup dan L∞ lebih besar dari panjang maksimum. Menggunakan nilai Z default.");
          Z = 1.8; // Default jika perhitungan gagal
        } else {
          drawCatchCurveChart(catchCurvePoints, regressionPoints);
        }
      } else {
        Z = 1.8;
        alert("Tidak ada data frekuensi panjang. Menggunakan nilai Z default untuk simulasi.");
      }
      
      // Hitung F (Mortalitas Penangkapan)
      const F = Z - M;
      
      // Simulasi model per-rekrut untuk mencari F_MSY dan F01
      const yprResult = calculateYPR(M, k, tc, tr);
      const F_MSY = yprResult.F_MSY;
      const F01 = yprResult.F01;
      const maxYPR = yprResult.maxYPR;
      
      drawYPRChart(yprResult.F_values, yprResult.YPR_values, F_MSY, F01);
      
      // Tampilkan hasil
      displayResults(M, Z, F, F_MSY, F01, maxYPR);
    }

    // Length-Converted Catch Curve untuk estimasi Z (diperbaiki)
    function calculateZWithLCCC(freqData, k, linf) {
      let debugHTML = "<h3>Debug Info - Length-Converted Catch Curve</h3>";
      debugHTML += "<p>Konversi panjang ke umur menggunakan rumus: t = - (1/k) * ln(1 - length/L∞)</p>";
      
      // 1. Konversi panjang ke umur relatif
      const ageData = [];
      freqData.forEach(item => {
        if (item.length >= linf) {
          debugHTML += `<p class="error">Peringatan: Panjang ${item.length} >= L∞ ${linf}. Data ini akan diabaikan.</p>`;
          return;
        }
        
        const t = - (1 / k) * Math.log(1 - item.length / linf);
        ageData.push({ length: item.length, t, freq: item.freq });
      });
      
      if (ageData.length === 0) {
        debugHTML += `<p class="error">Tidak ada data yang valid setelah konversi panjang ke umur. Pastikan panjang < L∞.</p>`;
        return { Z: NaN, debugInfo: debugHTML };
      }
      
      // 2. Urutkan berdasarkan umur
      ageData.sort((a, b) => a.t - b.t);
      
      // Tampilkan data konversi dalam tabel
      debugHTML += "<h4>Data Konversi Panjang ke Umur:</h4>";
      debugHTML += "<table class='data-table'>";
      debugHTML += "<tr><th>Panjang (cm)</th><th>Frekuensi</th><th>Umur (tahun)</th></tr>";
      ageData.forEach(item => {
        debugHTML += `<tr><td>${item.length.toFixed(1)}</td><td>${item.freq}</td><td>${item.t.toFixed(3)}</td></tr>`;
      });
      debugHTML += "</table>";
      
      // 3. Cari indeks frekuensi maksimum (puncak distribusi)
      let maxFreq = 0;
      let peakIndex = 0;
      
      ageData.forEach((item, index) => {
        if (item.freq > maxFreq) {
          maxFreq = item.freq;
          peakIndex = index;
        }
      });
      
      debugHTML += `<p>Puncak distribusi pada indeks ${peakIndex}: Panjang ${ageData[peakIndex].length.toFixed(1)} cm, Umur ${ageData[peakIndex].t.toFixed(3)} tahun, Frekuensi ${maxFreq}</p>`;
      
      // 4. Ambil data setelah puncak (bagian menurun)
      const decliningData = ageData.slice(peakIndex + 1); // Mulai dari setelah puncak
      
      if (decliningData.length < 2) {
        debugHTML += `<p class="error">Tidak cukup titik data untuk regresi (minimal 2 titik setelah puncak). Titik yang tersedia: ${decliningData.length}</p>`;
        return { Z: NaN, debugInfo: debugHTML };
      }
      
      debugHTML += "<h4>Data untuk Regresi (Bagian Menurun):</h4>";
      debugHTML += "<table class='data-table'>";
      debugHTML += "<tr><th>Umur (tahun)</th><th>Frekuensi</th><th>ln(Frekuensi)</th></tr>";
      
      // 5. Regresi linear untuk estimasi Z
      let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
      const n = decliningData.length;
      const validPoints = [];
      
      decliningData.forEach(item => {
        if (item.freq > 0) {
          const y = Math.log(item.freq);
          sumX += item.t;
          sumY += y;
          sumXY += item.t * y;
          sumX2 += item.t * item.t;
          
          validPoints.push({ t: item.t, lnFreq: y });
          debugHTML += `<tr><td>${item.t.toFixed(3)}</td><td>${item.freq}</td><td>${y.toFixed(3)}</td></tr>`;
        }
      });
      
      debugHTML += "</table>";
      
      if (validPoints.length < 2) {
        debugHTML += `<p class="error">Tidak cukup titik valid (frekuensi > 0) untuk regresi. Titik yang tersedia: ${validPoints.length}</p>`;
        return { Z: NaN, debugInfo: debugHTML };
      }
      
      // Hitung koefisien regresi
      const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
      const intercept = (sumY - slope * sumX) / n;
      
      // Z adalah negatif dari slope
      const Z = -slope;
      
      debugHTML += `<p>Hasil Regresi: Slope = ${slope.toFixed(4)}, Intercept = ${intercept.toFixed(4)}</p>`;
      debugHTML += `<p>Mortalitas Total (Z) = ${Z.toFixed(4)}</p>`;
      
      // Siapkan data untuk grafik
      const catchCurvePoints = ageData.map(item => ({
        x: item.t,
        y: item.freq > 0 ? Math.log(item.freq) : null,
        length: item.length
      }));
      
      const regressionPoints = decliningData.map(item => ({
        x: item.t,
        y: slope * item.t + intercept
      }));
      
      return { Z, catchCurvePoints, regressionPoints, debugInfo: debugHTML };
    }

    // Simulasi model per-rekrut untuk mencari F_MSY dan F01
    function calculateYPR(M, k, tc, tr) {
      const F_values = [];
      const YPR_values = [];
      let maxYPR = 0;
      let F_MSY = 0;
      let F01 = 0;
      
      // Parameter model
      const t0 = 0; // Asumsi umum
      const S = Math.exp(-k * (tc - t0));
      const t_diff = tc - tr;
      
      // Hitung kemiringan awal di F=0
      let slope0 = 0;
      let YPR0 = 0;
      
      // Simulasi untuk berbagai nilai F
      for (let F_val = 0; F_val <= 3; F_val += 0.05) {
        const Z_val = F_val + M;
        
        // Rumus Beverton-Holt untuk hasil per-rekrut (Y/R)
        const term1 = 1 / Z_val;
        const term2 = 3 * S / (Z_val + k);
        const term3 = 3 * Math.pow(S, 2) / (Z_val + 2 * k);
        const term4 = Math.pow(S, 3) / (Z_val + 3 * k);
        
        const YPR = F_val * Math.exp(-M * t_diff) * (term1 - term2 + term3 - term4);
        
        F_values.push(F_val);
        YPR_values.push(YPR);
        
        // Update F_MSY (nilai F yang menghasilkan YPR maksimum)
        if (YPR > maxYPR) {
          maxYPR = YPR;
          F_MSY = F_val;
        }
        
        // Hitung kemiringan awal untuk F01
        if (F_val === 0.05) {
          YPR0 = YPR;
          slope0 = (YPR - 0) / 0.05; // Kemiringan di F=0
        }
      }
      
      // Cari F01 (titik di mana kemiringan = 10% dari kemiringan di F=0)
      const targetSlope = 0.1 * slope0;
      
      for (let i = 1; i < F_values.length; i++) {
        const slope = (YPR_values[i] - YPR_values[i-1]) / (F_values[i] - F_values[i-1]);
        
        if (slope <= targetSlope) {
          F01 = F_values[i];
          break;
        }
      }
      
      return { F_values, YPR_values, F_MSY, F01, maxYPR };
    }

    // Fungsi untuk menampilkan hasil
    function displayResults(M, Z, F, F_MSY, F01, maxYPR) {
      const output = document.getElementById("output");
      const status = F <= F_MSY ? "status-good" : "status-danger";
      const statusText = F <= F_MSY ? "Berkelanjutan" : "Overfishing";
      
      output.innerHTML = `
        <div class="results-grid">
          <div class="result-card">
            <h4><i class="fas fa-leaf"></i> Mortalitas Alami (M)</h4>
            <div class="result-value">${M.toFixed(3)}</div>
            <p>Tingkat kematian alami ikan</p>
          </div>
          <div class="result-card">
            <h4><i class="fas fa-chart-line"></i> Mortalitas Total (Z)</h4>
            <div class="result-value">${Z.toFixed(3)}</div>
            <p>Total kematian (alami + penangkapan)</p>
          </div>
          <div class="result-card">
            <h4><i class="fas fa-fish"></i> Mortalitas Penangkapan (F)</h4>
            <div class="result-value">${F.toFixed(3)}</div>
            <p>Tingkat kematian akibat penangkapan</p>
          </div>
          <div class="result-card">
            <h4><i class="fas fa-bullseye"></i> F<sub>MSY</sub></h4>
            <div class="result-value">${F_MSY.toFixed(3)}</div>
            <p>F yang menghasilkan hasil maksimum berkelanjutan</p>
          </div>
          <div class="result-card">
            <h4><i class="fas fa-tachometer-alt"></i> F<sub>0.1</sub></h4>
            <div class="result-value">${F01.toFixed(3)}</div>
            <p>F di mana kemiringan Y/R 10% dari di F=0</p>
          </div>
          <div class="result-card">
            <h4><i class="fas fa-check-circle"></i> Status Perikanan</h4>
            <div class="result-value"><span class="status-indicator ${status}"></span>${statusText}</div>
            <p>Berdasarkan F saat ini vs F<sub>MSY</sub></p>
          </div>
        </div>
        <div class="explanation">
          <h4>Interpretasi Hasil:</h4>
          <ul>
            <li><strong>F saat ini (${F.toFixed(3)})</strong> ${F > F_MSY ? 'melebihi' : 'di bawah'} F<sub>MSY</sub> (${F_MSY.toFixed(3)})</li>
            <li>Untuk pengelolaan berkelanjutan, F harus dipertahankan di bawah F<sub>MSY</sub></li>
            <li>F<sub>0.1</sub> (${F01.toFixed(3)}) sering digunakan sebagai batas pengelolaan yang lebih konservatif</li>
            <li>Nilai Y/R maksimum: ${maxYPR.toFixed(4)} (satuan relatif)</li>
          </ul>
        </div>
      `;
    }

    // Fungsi untuk menggambar grafik catch curve
    function drawCatchCurveChart(points, regressionPoints) {
      const ctx = document.getElementById('catchCurveChart').getContext('2d');
      
      // Hancurkan grafik sebelumnya jika ada
      if (catchCurveChart) {
        catchCurveChart.destroy();
      }
      
      // Filter points yang valid (y tidak null)
      const validPoints = points.filter(p => p.y !== null);
      
      catchCurveChart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [
            {
              label: 'Data Catch Curve',
              data: validPoints.map(p => ({ x: p.x, y: p.y })),
              backgroundColor: 'rgba(54, 162, 235, 0.7)',
              pointRadius: 6
            },
            {
              label: 'Garis Regresi (Estimasi Z)',
              data: regressionPoints.map(p => ({ x: p.x, y: p.y })),
              backgroundColor: 'rgba(255, 99, 132, 0.5)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 2,
              pointRadius: 0,
              showLine: true,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Length-Converted Catch Curve'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `ln(Frekuensi): ${context.parsed.y.toFixed(2)}`;
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Umur Relatif (tahun)'
              }
            },
            y: {
              title: {
                display: true,
                text: 'ln(Frekuensi)'
              }
            }
          }
        }
      });
    }

    // Fungsi untuk menggambar grafik hasil per-rekrut
    function drawYPRChart(F_values, YPR_values, F_MSY, F01) {
      const ctx = document.getElementById('yprChart').getContext('2d');
      
      // Hancurkan grafik sebelumnya jika ada
      if (yprChart) {
        yprChart.destroy();
      }
      
      // Siapkan data untuk grafik
      const maxYPR = Math.max(...YPR_values);
      const msyIndex = F_values.findIndex(f => Math.abs(f - F_MSY) < 0.05);
      
      yprChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: F_values.map(f => f.toFixed(2)),
          datasets: [{
            label: 'Hasil Per-Rekrut (Y/R)',
            data: YPR_values,
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2,
            tension: 0.1,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            annotation: {
              annotations: {
                msyLine: {
                  type: 'line',
                  xMin: F_MSY,
                  xMax: F_MSY,
                  yMin: 0,
                  yMax: maxYPR,
                  borderColor: 'rgba(255, 99, 132, 1)',
                  borderWidth: 2,
                  borderDash: [6, 6],
                  label: {
                    display: true,
                    content: `F_MSY = ${F_MSY.toFixed(2)}`,
                    position: 'end'
                  }
                },
                f01Line: {
                  type: 'line',
                  xMin: F01,
                  xMax: F01,
                  yMin: 0,
                  yMax: maxYPR,
                  borderColor: 'rgba(75, 192, 192, 1)',
                  borderWidth: 2,
                  borderDash: [6, 6],
                  label: {
                    display: true,
                    content: `F0.1 = ${F01.toFixed(2)}`,
                    position: 'end'
                  }
                },
                msyPoint: {
                  type: 'point',
                  xValue: F_MSY,
                  yValue: YPR_values[msyIndex],
                  radius: 6,
                  backgroundColor: 'rgba(255, 99, 132, 1)',
                  label: {
                    display: true,
                    content: `Y/R Max: ${YPR_values[msyIndex].toFixed(4)}`,
                    position: 'top'
                  }
                }
              }
            },
            title: {
              display: true,
              text: 'Kurva Hasil Per-Rekrut'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Y/R: ${context.parsed.y.toFixed(4)}`;
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Mortalitas Penangkapan (F)'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Hasil Per-Rekrut (Y/R)'
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>